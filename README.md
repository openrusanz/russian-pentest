# russian-pentest
Цель проекта: 
1) принести прознарчность в работах по анлизу защиещнности и тестированию на проникнвоение в частности;
2) провести систематизацию текущих требования регуляторов к организации (в контексте анализа защищенности).

# Оглавление


## Нормативные требования регуляторов


## Внешний пентест

## Внутренний пентест:

### LLMNR/NBT-NS Poisoning

Данная атака позволяет захватывать Net-NTLM хеши, из которых путем перебора можно получить пару логин/пароль конкретного пользователя, что можно использовать на других этапах анализа защищенности. 
Атаку рекомендуется проводить либо рано утром – когда сотрудники Заказчика только начинают работу, либо после обеда – когда они же возвращаются к своим рабочим станциям.
В общем случае проведение атаки сводится к следующей последовательности действий:

1.	Запустить Responder:
> responder -I <interface> -rdw 
	
Запуск с текущими параметрами может негативно отразиться на сети.

2.	Подождать достаточный промежуток времени.
Захваченные хеши по умолчанию расположены в /usr/share/responder/logs. Для вывода захваченных хешей удобно воспользоваться DumpHash.py, расположенным в /usr/share/responder.

Получив первые хеши, рекомендуется воспользоваться «ldapdomaindump» с целью получения таблицы LDAP.

### NTLM Relay

Для потенциально успешного проведения атаки NTLM Relay (SMB Relay) необходимо:
•	отсутствие подписи SMB (SMB Signing) (за одним исключением)
•	пользователь должен иметь привилегии администратора на атакуемой машине.
Определить потенциальные цели для атаки можно при помощи ПО CrackMapExec (CME), которое по умолчанию НЕ предустановлено в Kali Linux, указав следующую команду
> cme smb <диапазон адресов> --gen-relay-list targets.txt 

Так же поиск хостов с отключенным SMB Signing можно выполнить при помощи nmap:
> nmap -script=smb2-security-mode.nse -p445 <диапазон адресов>

В общем случае проведение атаки сводится к следующей последовательности действий:
1.	Определить потенциальные цели атаки.
2.	Отключить SMB и HTTP сервера в файле конфигураций Responder.conf
3.	Запустить Responder:

> responder -I <interface> -rdw 
	
4. Запустить ntlmrelayx.py:
> ntlmrelayx.py -tf targets.txt -smb2support

Без указания дополнительных аргументов ntlmrelayx.py при успешной атаке сдампит базу данных SAM - будут получены NTLM хеши пользователей. Однако стоит помнить, что при помощи таких аргументов как -i/-c/-e / -socks мы можем открывать шелл, выполнять произвольные команды, доставлять полезную нагрузку, запускать прокси. 
По умолчанию атаки будут нацелены на протокол SMB, но также стоит попробовать произвести атаку на LDAP чтобы получить LDAP-базу данных:

> ntlmrelayx.py ldap://<DC> -l loot_dir

Каждый пользователь по умолчанию имеет возможность создать до 10 компьютеров в домене. Чтобы создать компьютер, нужно выполнить релей на контроллер домена по протоколу LDAPS. Создание пользователей и компьютеров по незашифрованному соединению LDAPS запрещено за, возможно, исключением старых версий Windows Server.

> ntlmrelayx.py -t ldaps://<DC> -add-computer -l loot_dir

Если же SMB подпись включена, обязательно стоит осуществить атаку на LDAP/LDAPS, т.к. по умолчанию, для него не требуется подпись. Таким образом, осуществляя relay обычных пользователей на LDAP, мы так же можем выгрузить базу данных LDAP, а в случае relay администратора, мы можем скомпрометировать домен
	
### IPv6 - Атака
Если в корпоративной сети используется IPv6, атакующий может ответить на запросы DHCPv6 и установить в качестве DNS-сервера на атакуемой машине свой IP-адрес. Так как IPv6 имеет приоритет над IPv4, DNS-запросы клиента будут отправлены на адрес атакующего. Запуск атаки:
> mitm6 -d domain.local

Где «domain.local» - атакуемый домен. При помощи данной атаки возможно осуществить:
1.	Сбор Net-NTLM хешей: (проверить просто респондером)
> smbserver.py -smb2support SMB /root/SMB

2.	Атаки на LDAP(S) при подделке WPAD:
Как только жертва установит атакующего в качестве DNS-сервера IPv6, она начнет запрашивать конфигурацию сети WPAD. Атакующий отправляет жертве действительный WPAD, в котором он является прокси-сервером. Когда жертва подключается к «прокси-серверу», он запрашивает NetNTLM аунтентификацию, полученный хеш пересылается дальше на атакуемый ресурс. Подробнее. (https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/)

 > ntlmrelayx.py -6 -t ldaps://<DC> -wh fakewpad.domain.local -l loot_folder
	
Эта атака может быть произведена так же в любом другом случае при компрометации DNS-сервера.
В обычно случае будет собрана база данных LDAP, как в атаке выше (вставить ссылку на LDAP). Если же будет пойман NetNTLM хеш администратора домена, будет совершена попытка создать нового пользователя на КД, что может привести к его компрометации. Данная атака будет работать даже с включенной SMB подписью.
